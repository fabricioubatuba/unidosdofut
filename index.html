<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Unidos do Fut — Escalação</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f1724;
      --card:#ffffff;
      --muted:#6b7280;
      --azul:#0d6efd;
      --preto:#111827;
      --laranja:#f97316;
      --success:#10b981;
      --danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
      background:linear-gradient(180deg,#f3f4f6 0%,#fff 100%);
      color:#111827;
      padding:12px;
    }
    .app{max-width:960px;margin:auto;display:flex;flex-direction:column;gap:12px}
    header.card{
      background:var(--bg);color:#fff;padding:14px;border-radius:12px;
      display:flex;gap:12px;align-items:center;box-shadow:0 6px 18px rgba(2,6,23,0.12);
    }
    .brand{display:flex;gap:12px;align-items:center}
    .logo{
      width:56px;height:56px;border-radius:10px;
      background:linear-gradient(90deg,var(--azul),var(--laranja));
      display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;font-size:20px;
    }
    h1{margin:0;font-size:18px}
    .hdr-right{margin-left:auto;display:flex;gap:8px;align-items:center}
    .auth-box{display:flex;flex-direction:column;gap:8px;align-items:flex-start}
    .auth-input{padding:8px;border-radius:8px;border:1px solid #e5e7eb;width:200px}
    .auth-btn{
      background:#fff;color:#111827;border-radius:8px;padding:8px 10px;border:none;font-weight:600;cursor:pointer;
    }
    .card{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 4px 12px rgba(2,6,23,0.06);}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:12px}
    @media(max-width:880px){.grid{grid-template-columns:1fr}}
    input[type="text"]{padding:10px;border-radius:8px;border:1px solid #e5e7eb;flex:1;font-size:14px}
    button.primary{
      background:var(--azul);color:#fff;border:none;padding:10px 12px;border-radius:10px;font-weight:700;cursor:pointer;
    }
    button.ghost{background:transparent;border:1px solid #e5e7eb;padding:8px 10px;border-radius:8px;cursor:pointer}
    .list{display:flex;flex-direction:column;gap:8px}
    .player{display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:10px;border:1px solid #f3f4f6}
    .remove{background:var(--danger);color:#fff;border:none;padding:6px 8px;border-radius:8px;cursor:pointer;font-size:13px}
    .stars{display:inline-flex;gap:4px}
    .star{width:26px;height:26px;border-radius:6px;display:flex;align-items:center;justify-content:center;cursor:pointer;border:1px solid #e5e7eb;font-weight:700}
    .star.on{background:linear-gradient(90deg,var(--azul),#3b82f6);color:white;border:none}
    .star.dim{opacity:.45}
    .team-choice{display:flex;gap:8px}
    .team-choice button{flex:1;padding:10px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;cursor:pointer;transition:all 0.2s}
    .team-choice .active{background:var(--azul);color:white;box-shadow:0 6px 18px rgba(2,6,23,0.12);transform:translateY(-2px);font-weight:bold}
    #resultPreview{white-space:pre-wrap;font-family:monospace;background:#f8fafc;padding:10px;border-radius:8px;border:1px dashed #e6eef8;min-height:60px}
    .badge{display:inline-block;padding:6px 10px;border-radius:999px;color:#fff;font-weight:700}
    .badge.azul{background:var(--azul)}.badge.preto{background:linear-gradient(90deg,#000,#111827)}.badge.laranja{background:var(--laranja)}
    @media (max-width:480px){.star{width:34px;height:34px}}
  </style>
</head>
<body>
  <div class="app">
    <header class="card">
      <div class="brand">
        <div class="logo">UDF</div>
        <div>
          <h1>Unidos do Fut</h1>
          <div style="font-size:12px;color:#cbd5e1">Sorteio de times — versão Firebase</div>
        </div>
      </div>
      <div class="hdr-right">
        <div id="userBox" class="auth-box">
          <input id="email" type="email" class="auth-input" placeholder="E-mail" />
          <input id="password" type="password" class="auth-input" placeholder="Senha" />
          <button id="btnLogin" class="auth-btn">Entrar</button>
        </div>
        <div id="userInfo" style="display:none;flex-direction:column;align-items:flex-end">
          <div style="font-size:12px">Logado como <strong id="userEmail"></strong></div>
          <button id="btnLogout" class="auth-btn">Sair</button>
        </div>
      </div>
    </header>

    <!-- BLOQUEADO -->
    <div id="locked" class="card" style="display:none">
      <h3>Acesso restrito</h3>
      <p>Somente usuários autorizados podem acessar este painel.</p>
    </div>

    <!-- PAINEL PRINCIPAL -->
    <main id="mainApp" style="display:none">
      <section class="card">
        <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">
          <div style="flex:1;min-width:180px">
            <label><strong>Quantos times?</strong></label>
            <div class="team-choice">
              <button id="t2" class="active" onclick="setTeams(2)">2 Times</button>
              <button id="t3" onclick="setTeams(3)">3 Times</button>
            </div>
          </div>
          <div>
            <label><strong>Ações</strong></label><br>
            <button class="primary" onclick="sortAndOpen()">Sortear Times</button>
            <button class="ghost" onclick="saveAllToFirebase()">Salvar</button>
            <button class="ghost" onclick="clearAll()">Limpar</button>
          </div>
        </div>
      </section>

      <div class="grid">
        <section class="card">
          <h3>Goleiros <span id="gkCount"></span></h3>
          <div style="display:flex;gap:8px;margin-bottom:8px">
            <input id="newGk" type="text" placeholder="Nome do goleiro" />
            <button class="primary" onclick="addGk()">Adicionar</button>
          </div>
          <div id="gkList" class="list"></div>

          <hr>
          <h3>Jogadores Fixos <span id="fixedCount"></span></h3>
          <div style="display:flex;gap:8px;margin-bottom:8px;align-items:center">
            <input id="newFixed" type="text" placeholder="Nome do jogador fixo" />
            <div id="fixedStars" class="stars"></div>
            <button class="primary" onclick="addFixed()">Adicionar</button>
          </div>
          <div id="fixedList" class="list"></div>

          <hr>
          <h3>Jogadores Avulsos <span id="casualCount"></span></h3>
          <div style="display:flex;gap:8px;margin-bottom:8px;align-items:center">
            <input id="newCasual" type="text" placeholder="Nome do jogador avulso" />
            <div id="casualStars" class="stars"></div>
            <button class="primary" onclick="addCasual()">Adicionar</button>
          </div>
          <div id="casualList" class="list"></div>
        </section>

        <aside class="card">
          <h3>Resumo</h3>
          <div id="counts" style="font-size:13px;color:#6b7280"></div>
          <div id="resultPreview">Adicione jogadores para visualizar o equilíbrio dos times.</div>
        </aside>
      </div>
    </main>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAU61nxSJAx8LZNLmyhE82x48uTemrGbxI",
      authDomain: "unidosdofut-6581e.firebaseapp.com",
      databaseURL: "https://unidosdofut-6581e-default-rtdb.firebaseio.com",
      projectId: "unidosdofut-6581e",
      storageBucket: "unidosdofut-6581e.firebasestorage.app",
      messagingSenderId: "118138503177",
      appId: "1:118138503177:web:81d39c5eda8662a530b8d8"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const ALLOWED = ["unidosdofut@unidosdofut.com","bioranss@gmail.com"];
    
    // Estado inicial garantido
    let state = {
      teams: 2,
      goalkeepers: [],
      fixedPlayers: [],
      casualPlayers: []
    };
    
    // Variáveis globais para controle das estrelas
    let fixedStarsValue = 3;
    let casualStarsValue = 2;

    // login
    const btnLogin = document.getElementById('btnLogin');
    const btnLogout = document.getElementById('btnLogout');
    const email = document.getElementById('email');
    const password = document.getElementById('password');
    const mainApp = document.getElementById('mainApp');
    const locked = document.getElementById('locked');
    const userInfo = document.getElementById('userInfo');
    const userEmailEl = document.getElementById('userEmail');
    const userBox = document.getElementById('userBox');

    btnLogin.addEventListener('click', async () => {
      try {
        const res = await signInWithEmailAndPassword(auth, email.value.trim(), password.value.trim());
      } catch (e) { alert("Erro: " + e.message) }
    });
    btnLogout.addEventListener('click', () => signOut(auth));

    onAuthStateChanged(auth, async (user) => {
      if (user && ALLOWED.includes(user.email)) {
        userBox.style.display = 'none';
        userInfo.style.display = 'flex';
        userEmailEl.textContent = user.email;
        locked.style.display = 'none';
        mainApp.style.display = 'block';
        await loadData();
      } else if (user) {
        mainApp.style.display = 'none';
        locked.style.display = 'block';
      } else {
        mainApp.style.display = 'none';
        locked.style.display = 'none';
        userBox.style.display = 'flex';
        userInfo.style.display = 'none';
      }
    });

    async function saveAllToFirebase() {
      const user = auth.currentUser;
      if (!user) return;
      await set(ref(db, "unidosdofut/last"), state);
      console.log("salvo");
    }
    
    async function loadData() {
      try {
        const snap = await get(ref(db, "unidosdofut/last"));
        if (snap.exists()) {
          const data = snap.val();
          // Garantir que todas as propriedades existam
          state = {
            teams: data.teams || 2,
            goalkeepers: data.goalkeepers || [],
            fixedPlayers: data.fixedPlayers || [],
            casualPlayers: data.casualPlayers || []
          };
          renderAll();
        }
      } catch (error) {
        console.error("Erro ao carregar dados:", error);
      }
    }

    // === interface ===
    const gkList = document.getElementById('gkList');
    const fixedList = document.getElementById('fixedList');
    const casualList = document.getElementById('casualList');
    const gkCount = document.getElementById('gkCount');
    const fixedCount = document.getElementById('fixedCount');
    const casualCount = document.getElementById('casualCount');
    const preview = document.getElementById('resultPreview');

    function createStars(container, initial, onChange) {
      container.innerHTML = '';
      let val = initial;
      for (let i = 1; i <= 4; i++) {
        const s = document.createElement('div');
        s.className = 'star ' + (i <= val ? 'on' : 'dim');
        s.textContent = '★';
        s.dataset.v = i;
        s.onclick = () => {
          val = i;
          update();
          onChange(i);
        };
        container.appendChild(s);
      }
      function update() {
        container.querySelectorAll('.star').forEach(st => {
          st.classList.toggle('on', st.dataset.v <= val);
          st.classList.toggle('dim', st.dataset.v > val);
        });
      }
      update();
    }

    // Inicializar estrelas
    createStars(document.getElementById('fixedStars'), fixedStarsValue, (v) => { fixedStarsValue = v; });
    createStars(document.getElementById('casualStars'), casualStarsValue, (v) => { casualStarsValue = v; });

    function renderAll() {
      // Garantir que os arrays existam
      if (!state.goalkeepers) state.goalkeepers = [];
      if (!state.fixedPlayers) state.fixedPlayers = [];
      if (!state.casualPlayers) state.casualPlayers = [];
      
      renderList(gkList, state.goalkeepers, 'gk');
      renderList(fixedList, state.fixedPlayers, 'fixed');
      renderList(casualList, state.casualPlayers, 'casual');
      gkCount.textContent = `(${state.goalkeepers.length})`;
      fixedCount.textContent = `(${state.fixedPlayers.length})`;
      casualCount.textContent = `(${state.casualPlayers.length})`;
      updatePreview();
    }

    function renderList(container, arr, type) {
      if (!arr || !Array.isArray(arr)) {
        console.error(`Array ${type} não é válido:`, arr);
        return;
      }
      
      container.innerHTML = '';
      arr.forEach((p, i) => {
        const div = document.createElement('div');
        div.className = 'player';
        let starsHtml = '';
        if (type !== 'gk') {
          for (let s = 1; s <= 4; s++) {
            starsHtml += `<div class="star ${s <= p.score ? 'on' : 'dim'}" data-v="${s}">★</div>`;
          }
        }
        div.innerHTML = `<div>${p.name}${type !== 'gk' ? ` <span class='stars'>${starsHtml}</span>` : ''}</div><button class='remove'>Remover</button>`;
        div.querySelector('.remove').onclick = () => {
          arr.splice(i, 1);
          renderAll();
          saveAllToFirebase();
        };
        if (type !== 'gk') {
          div.querySelectorAll('.star').forEach(st => {
            st.onclick = () => {
              p.score = Number(st.dataset.v);
              renderAll();
              saveAllToFirebase();
            };
          });
        }
        container.appendChild(div);
      });
    }

    function addGk() {
      const v = document.getElementById('newGk').value.trim();
      if (!v) return;
      if (!state.goalkeepers) state.goalkeepers = [];
      state.goalkeepers.push({ name: v });
      document.getElementById('newGk').value = '';
      renderAll();
      saveAllToFirebase();
    }
    
    function addFixed() {
      const v = document.getElementById('newFixed').value.trim();
      if (!v) return;
      if (!state.fixedPlayers) state.fixedPlayers = [];
      state.fixedPlayers.push({ name: v, score: fixedStarsValue });
      document.getElementById('newFixed').value = '';
      renderAll();
      saveAllToFirebase();
    }
    
    function addCasual() {
      const v = document.getElementById('newCasual').value.trim();
      if (!v) return;
      if (!state.casualPlayers) state.casualPlayers = [];
      state.casualPlayers.push({ name: v, score: casualStarsValue });
      document.getElementById('newCasual').value = '';
      renderAll();
      saveAllToFirebase();
    }

    function clearAll() {
      if (!confirm("Limpar todos os dados?")) return;
      state = {
        teams: state.teams,
        goalkeepers: [],
        fixedPlayers: [],
        casualPlayers: []
      };
      renderAll();
      saveAllToFirebase();
    }

    function setTeams(n) {
      state.teams = n;
      document.getElementById('t2').classList.toggle('active', n === 2);
      document.getElementById('t3').classList.toggle('active', n === 3);
      saveAllToFirebase();
    }

    function updatePreview() {
      // Garantir que os arrays existam
      const fixedCount = state.fixedPlayers ? state.fixedPlayers.length : 0;
      const casualCount = state.casualPlayers ? state.casualPlayers.length : 0;
      const total = fixedCount + casualCount;
      
      if (total < 2) {
        preview.textContent = "Poucos jogadores.";
        return;
      }
      
      const players = [
        ...(state.fixedPlayers || []),
        ...(state.casualPlayers || [])
      ];
      
      const sorted = players.sort((a, b) => b.score - a.score);
      const k = state.teams;
      const teams = Array.from({ length: k }, (_, i) => ({ score: 0, players: [] }));
      
      sorted.forEach(p => {
        teams.sort((a, b) => a.score - b.score);
        teams[0].players.push(p);
        teams[0].score += p.score;
      });
      
      let t = "Equilíbrio estimado:\n";
      teams.forEach((tm, i) => t += `Time ${i + 1}: ${tm.score} pts\n`);
      preview.textContent = t;
    }

    function balanceTeams() {
      // Garantir que os arrays existam
      const players = [
        ...(state.fixedPlayers || []),
        ...(state.casualPlayers || [])
      ];
      
      const shuffled = players.sort(() => Math.random() - 0.5).sort((a, b) => b.score - a.score);
      const k = state.teams;
      const names = k === 2 ? ["Azul", "Preto"] : ["Azul", "Preto", "Laranja"];
      const colors = { Azul: "azul", Preto: "preto", Laranja: "laranja" };
      const teams = names.map(n => ({ name: n, color: colors[n], players: [], score: 0 }));
      
      // Distribuir goleiros
      const shuffledGks = [...(state.goalkeepers || [])].sort(() => Math.random() - 0.5);
      teams.forEach((team, i) => {
        if (i < shuffledGks.length) {
          team.players.push({ name: shuffledGks[i].name, role: "Goleiro" });
        }
      });
      
      // Distribuir jogadores de linha
      shuffled.forEach(p => {
        teams.sort((a, b) => a.score - b.score);
        teams[0].players.push({ name: p.name, role: "Linha", score: p.score });
        teams[0].score += p.score;
      });
      
      // Embaralhar a ordem dos times para exibição aleatória
      const shuffledTeams = teams.sort(() => Math.random() - 0.5);
      
      return { teams: shuffledTeams };
    }

    function sortAndOpen() {
      // Garantir que os arrays existam
      const fixedCount = state.fixedPlayers ? state.fixedPlayers.length : 0;
      const casualCount = state.casualPlayers ? state.casualPlayers.length : 0;
      
      if (fixedCount + casualCount < 2) {
        alert("Poucos jogadores.");
        return;
      }
      
      const res = balanceTeams();
      const html = `<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8'>
  <meta name='viewport' content='width=device-width,initial-scale=1'>
  <title>Times Sorteados</title>
  <style>
    body{font-family:Inter,Arial;padding:16px;background:#f8fafc;color:#111827;max-width:800px;margin:0 auto}
    .header{text-align:center;margin-bottom:24px}
    .pontuacao{display:flex;justify-content:center;gap:16px;margin-bottom:24px;flex-wrap:wrap}
    .pontuacao-item{background:#fff;border-radius:12px;padding:12px;box-shadow:0 4px 12px rgba(2,6,23,0.08);text-align:center;min-width:120px}
    .pontuacao-numero{font-size:24px;font-weight:bold}
    .team{background:#fff;border-radius:12px;padding:16px;margin-bottom:16px;box-shadow:0 4px 12px rgba(2,6,23,0.08)}
    .team-header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    .badge{padding:6px 12px;border-radius:999px;color:#fff;font-weight:700}
    .azul{background:#0d6efd}
    .preto{background:linear-gradient(90deg,#000,#111827)}
    .laranja{background:#f97316}
    .jogador-linha{margin:4px 0}
    .goleiro{font-weight:bold;margin-top:8px}
    button{background:#111827;color:#fff;border:none;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer;margin:8px}
    .botoes{text-align:center;margin-top:24px}
  </style>
</head>
<body>
  <div class="header">
    <h2>Times Escalados</h2>
  </div>
  
  <div class="pontuacao">
    ${res.teams.map((t, i) => `
      <div class="pontuacao-item">
        <div>${i+1}º</div>
        <div class="pontuacao-numero">${t.score} pts</div>
        <div class="badge ${t.color}">${t.name}</div>
      </div>
    `).join("")}
  </div>
  
  ${res.teams.map((t, i) => `
    <div class='team'>
      <div class='team-header'>
        <span class='badge ${t.color}'>${t.name}</span>
        <span><strong>${i+1}º</strong></span>
      </div>
      <div class='goleiro'>Goleiro: ${t.players.find(p=>p.role==="Goleiro")?.name||"—"}</div>
      <ul>
  ${t.players.filter(p=>p.role==="Linha").map((p,j)=>`<li class="jogador-linha">${j+1}. ${p.name}</li>`).join("")}
</ul>
</div>
  `).join("")}
  
  <div class="botoes">
    <button onclick="window.location.reload()">Novo Sorteio</button>
    <button onclick="window.close()">Voltar</button>
  </div>
</body>
</html>`;
      const w = window.open('', '_blank', 'width=800,height=800');
      w.document.write(html);
      w.document.close();
    }

    // Inicializar a interface
    renderAll();
    
    // === tornar funções acessíveis no HTML ===
    window.addGk = addGk;
    window.addFixed = addFixed;
    window.addCasual = addCasual;
    window.saveAllToFirebase = saveAllToFirebase;
    window.clearAll = clearAll;
    window.sortAndOpen = sortAndOpen;
    window.setTeams = setTeams;
  </script>
</body>
</html>
